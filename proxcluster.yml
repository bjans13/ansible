---
  - name: Update and Reboot Proxmox Servers with Ceph HA
    hosts: servers
    become: yes
    serial: 1  # Run on one servers at a time
    tasks:

      - name: Gather facts
    setup:

      - name: Update package lists
        apt:
          update_cache: yes
  
      - name: Upgrade all packages
        apt:
          upgrade: dist

      - name: Autoremove unnecessary packages
        apt:
         autoremove: yes
  
      - name: Reboot servers
        reboot:
          post_reboot_delay: 420

      - name: Check if reboot is required
        stat:
          path: /var/run/reboot-required
        register: reboot_required
        when: ansible_os_family == "Debian"

      - name: Check if SSH is back online after reboot
        wait_for:
          host: "{{ inventory_hostname }}"
          port: 22
          state: started
          delay: 45
          timeout: 300
        check_mode: no
